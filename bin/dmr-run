#!/usr/bin/env node

/*
 * @Author: qiansc 
 * @Date: 2018-04-02 11:18:49 
 * @Last Modified by: qiansc
 * @Last Modified time: 2018-05-06 19:14:08
 */

let Log = require('../lib/util/log');
let program = require('commander');
let path = require('path');
let log = new Log(2);

let SuperTask = require('../lib/task/task-super');
let Config = require('../lib/core/config.js');
let Action = require('../lib/core/action');
let parseAction = require('../lib/util/parse-action');
let parseRange = require('../lib/util/parse-range');

let taskId, file, action, key, range;

program
  .version('0.1.0', '-v, --version')
  .option('-s, --start <items>', 'Start Date / Datetime')
  .option('-e, --end <items>', 'End Date / Datetime')
  .option('-r, --range <value>', 'Ranges(d,h,m,s) [option]')
  .option('-f, --file <file>', 'Output File [option]')
  .option('-k, --key <value>', 'Prev Action Key [option]')
  .option('-l, --log <value>', 'Log Output Level Since Less to All( 0 ~ 9 )')
  .option('-p, --project <value>', 'Specify Project');

program.on('--help', function(){
    log.info('');
    log.info('  Examples:');
    log.info('');
    log.info('    $ dmr run acit -s 20180401.1200.00 -e 20180401120010');
    log.info('    $ dmr run acit -s 20180401.1200.00 -r 10s');
    log.info('    $ dmr run acit -s 20180401120000 -r 10s -f ./rs.log');
    log.info('    $ dmr run acit -s -5m -r 10s');
    log.info('    $ dmr run acit -s -5m -r 10s -l 0');
    log.info('    $ dmr run acit -s -5m -r 10s -p speedup-ace ');
    log.info('');
    log.info('  Supported Task:');
    log.info('');
    log.info('    acit      import and transfer search_ac.log');
    log.info(' ');
});

program.command('*').description('Task Id')
.action(function(arg){
    taskId = arg;
});

program.parse(process.argv);

file = program.file || false;
key = program.key || false;
action = new Action();


if (program.log !== undefined){
    Log.setGlobalLev(program.log);
}

/**
 *  命令提示
 */
log.info('------------------------------------------------------------------------');
// log.group('    ');
log.info('You will start a task with following config:');
log.info('\r\n');

// Deal Task Id
if (taskId){
    log.info('Task Name\t\t', taskId);
    let config = Config.find('task',taskId);
    if (config.description) {
        log.info('Task Description\t ' + config.description);
    }
}else {
    log.info('Task ID is required!');
    return;
}

// Deal File
if (file == "default") {
    action.set("file", "default");
    log.info('FilePath ', 'Use TaskConfig');
} else if (file){
    // 从当前命令执行路径计算目标路径，会覆盖task默认file
    file = path.resolve(process.cwd(), file);
    action.set('file', file);
}

// Deal Project

if (program.project) {
    log.info('Specify Project >>> ' + program.project);
}

// log.groupEnd();
log.info('------------------------------------------------------------------------\r\n');

// Deal Key && Range
range = parseRange(program);
if (key){
    // 从当前命令执行路径计算目标路径，会覆盖task默认file
    // file = path.resolve(process.cwd(), file);
    // action.set('file', file);
    // log.info('[file] ', file);
    action = parseAction(key);
    action.set('config', Config.find('task',taskId));
} else if (range) {
    log.info('' + range.toString('\r\n'));
    action.set('range', range.param());
    action.set('config', Config.find('task',taskId));
} else {
    log.info('Key or RangeInfo is required!');
    return;
}


let task = new SuperTask(action);

task.run();